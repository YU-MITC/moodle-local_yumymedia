{"version":3,"file":"accessrestriction.min.js","sources":["../src/accessrestriction.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * YU Kaltura \"My Media\" script for acecss restriction setting.\n *\n * @copyright (C) 2016-2023 Yamaguchi University (gh-cc@mlex.cc.yamaguchi-u.ac.jp)\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module local_yumymedia/accessrestriction\n */\n\ndefine(['jquery'], function($) {\n\n    return {\n        /**\n         * Initial function.\n         * @access public\n         */\n        init: function() {\n\n            var STATUS = {\n                ENTRY_ERROR_IMPORTING: -2,\n                ENTRY_ERROR_CONVERTING: -1,\n                ENTRY_IMPORT: 0,\n                ENTRY_PRECONVERT: 1,\n                ENTRY_READY: 2,\n                ENTRY_DELETED: 3,\n                ENTRY_PENDING: 4,\n                ENTRY_MODERATE: 5,\n                ENTRY_BLOCKED: 6,\n                ENTRY_NO_CONTENT: 7\n            };\n\n            /**\n             * This function centerize modal window.\n             */\n            function centeringModalSyncer() {\n\n                // Get width and height of window.\n                var w = $(window).width();\n                var h = $(window).height();\n\n                // Get width and height of content area.\n                var cw = $(\"#modal_content\").outerWidth();\n                var ch = $(\"#modal_content\").outerHeight();\n\n                // Execute centering.\n                $(\"#modal_content\").css({\"left\": ((w - cw) / 2) + \"px\", \"top\": ((h - ch) / 2) + \"px\"});\n            }\n\n            /**\n             * This function print modal window.\n             * @return {bool} - If modal window open, return true. Otherwise return false.\n             */\n            function fadeInModalWindow() {\n                // All contents in web page release focus.\n                $(this).blur();\n                // Precent dupulicate execute of modal window.\n                if ($(\"#modal_window\")[0]) {\n                    return false;\n                }\n\n                // Create modal window and a content area.\n                $(\"body\").append(\"<div id=\\\"modal_window\\\"></div>\");\n                $(\"#modal_window\").fadeIn(\"slow\");\n\n                // Centering content area.\n                centeringModalSyncer();\n                // Fade-in content area.\n                $(\"#modal_content\").fadeIn(\"slow\");\n                return true;\n            }\n\n            /**\n             * This is callback function whem cancel button is clicked.\n             * @param {string} url - URL of taget page.\n             */\n            function handleCancelClick(url) {\n                location.href = url;\n            }\n\n            /**\n             * This function add back button to modal window.\n             * @param {string} url - URL of target page.\n             */\n            function addBackButton(url) {\n                var contentHtml = \"<input type=button id=\\\"backToMymedia\\\" name=\\\"backToMymedia\\\" value=Back />\";\n                $(\"#modal_content\").append(contentHtml);\n                $(\"#backToMyMedia\").on(\"click\", function() {\n                    handleCancelClick(url);\n                });\n            }\n\n            /**\n             * This is callback function when access control setting is changed.\n             */\n            function selectedControl() {\n                require(['core/str', 'core/notification'], function(str, notification) {\n                    var strings = [\n                        {key: 'heading_access_control', component: 'local_yumymedia'},\n                        {key: 'accesscontrol_changed', component: 'local_yumymedia'}\n                    ];\n                    str.get_strings(strings).then(function(results) {\n                        var selectedControlId = $(\"#access_control_select\").val();\n                        var currentControlId = $(\"#currentcontrol\").val();\n\n                        var newLabel = results[0];\n\n                        if (selectedControlId != currentControlId) {\n                            newLabel = newLabel + \" <font color=\\\"red\\\">(\" + results[1] + \")</font>\";\n                            $(\"#access_media_save\").prop(\"disabled\", false);\n                        } else {\n                            $(\"#access_media_save\").prop(\"disabled\", true);\n                        }\n\n                        $(\"#access_control_label\").html(newLabel);\n                        return 0;\n                    }).fail(notification.exception);\n                });\n            }\n\n            /**\n             * This function update access control id.\n             */\n            function updateAccessControlId() {\n                var entryStatus;\n                var findData;\n\n                var controlId = $(\"#access_control_select\").val();\n                var entryId = $(\"#entryid\").val();\n                var serverHost = $(\"#kalturahost\").val();\n                var ks = $(\"#ks\").val();\n\n                // Create form data.\n                var fd = new FormData();\n                fd.append(\"action\", \"update\");\n                fd.append(\"ks\", ks);\n                fd.append(\"entryId\", entryId);\n                fd.append(\"baseEntry:accessControlId\", controlId);\n\n                // Create data is transmitted.\n                var postData = {\n                    type: \"POST\",\n                    data: fd,\n                    cache: false,\n                    async: true,\n                    contentType: false,\n                    scriptCharset: \"utf-8\",\n                    processData: false,\n                    dataType: \"xml\"\n                };\n\n                var serviceURL = serverHost + \"/api_v3/service/baseEntry/action/update\";\n\n                // Transmits data.\n                $.ajax(\n                   serviceURL, postData\n                )\n                .done(function(xmlData) {\n                    // When XML data is not received.\n                    if (xmlData === null || typeof xmlData === undefined) {\n                        printErrorMessage(\"Update failed (Cannot get a XML response)\");\n                        return;\n                    }\n\n                    // Get a tag of error code.\n                    findData = $(xmlData).find(\"code\");\n                    // When error code exists.\n                    if (findData !== null && typeof findData !== undefined && findData.text() !== \"\") {\n                        printErrorMessage(\"Update failed (\" + findData.text() + \")\");\n                        return;\n                    }\n\n                    // Get a tag of status.\n                    findData = $(xmlData).find(\"status\");\n                    // Where tag of statis not exists.\n                    if (findData === null || typeof findData === undefined || findData.text() === \"\") {\n                        printErrorMessage(\"Update failed (Cannot get a baseEntry)\");\n                        return;\n                    }\n\n                    // Get status value.\n                    entryStatus = findData.text();\n                    // When updating of access control is failed.\n                    if (entryStatus != STATUS.ENTRY_READY && entryStatus != STATUS.ENTRY_PENDING &&\n                        entryStatus != STATUS.ENTRY_PRECONVERT) {\n                        printErrorMessage(\"Update failed (status of baseEntry: \" + entryStatus + \")\");\n                        return;\n                    }\n\n                    // Get a tag of access control.\n                    findData = $(xmlData).find(\"accessControlId\");\n                    // When tag of acecss control not exists.\n                    if (findData === null || typeof findData === undefined || findData.text() === \"\") {\n                        printErrorMessage(\"Update failed(Cannot get an accessControlId)\");\n                        return;\n                    }\n\n                    // Get a value of access control.\n                    var resultId = findData.text();\n                    // When updating of access control is failed.\n                    if (resultId != controlId) {\n                        printErrorMessage(\"Update failed(accessControlId: \" + resultId + \")\");\n                        return;\n                    }\n\n                    // Print a success message.\n                    printSuccessMessage(resultId);\n                })\n                .fail(function(xmlData) {\n                    if (xmlData !== null) {\n                        window.console.dir(xmlData);\n                    }\n                    printErrorMessage(\"Update fialed(Cannot connect to contents server)\");\n                    return;\n                });\n            }\n\n            /**\n             * This function print a success message.\n             * @param {string} currentControl - Label of current access control.\n             */\n            function printSuccessMessage(currentControl) {\n                require(['core/str', 'core/notification'], function(str, notification) {\n                    var strings = [\n                        {key: 'accesscontrol_updated', component: 'local_yumymedia'}\n                    ];\n                    str.get_strings(strings).then(function(results) {\n                        var mymedia = $(\"#mymedia\").val();\n                        $(\"#access_media_save\").prop(\"disabled\", true);\n                        $(\"#currentcontrol\").val(currentControl);\n\n                        // View modal window.\n                        fadeInModalWindow();\n                        // Append message to content area.\n                        $(\"#modal_content\").append(\"<p>\" + results[0] + \"</p><br>\");\n                        // Append back button to content area.\n                        addBackButton(mymedia);\n                        // Close session to kaltura server.\n                        sessionEnd();\n                        // Jump tp my media page.\n                        setTimeout(function() {\n                            window.location.replace(mymedia);\n                        }, 1000);\n                        return 0;\n                    }).fail(notification.exception);\n                });\n            }\n\n            /**\n             * This function print error message.\n             * @param {string} message - message string.\n             */\n            function printErrorMessage(message) {\n                var mymedia = $(\"#mymedia\").val();\n\n                // Create error message.\n                message = \"<p><font color=red>\" + message + \"</font></p><br>\";\n                // View modal window.\n                fadeInModalWindow();\n                // Append error message to content area.\n                $(\"#modal_content\").append(message);\n                // Append back buttion to content area.\n                addBackButton(mymedia);\n                // Close session to kaltura server.\n                sessionEnd();\n            }\n\n            /**\n             * This function close a session between client and kaltura server.\n             */\n            function sessionEnd() {\n                var serverHost = $(\"#kalturahost\").val();\n                var serviceURL = serverHost + \"/api_v3/service/session/action/end\";\n\n                // Transmit from data.\n                $.ajax({\n                    type: \"GET\",\n                    url: serviceURL,\n                    cache: false\n                })\n                .done(function(xmlData) {\n                    // When format of response is not XML.\n                    if (xmlData !== null) {\n                        window.console.dir(xmlData);\n                    }\n                })\n                .fail(function(xmlData) {\n                    if (xmlData !== null) {\n                        window.console.dir(xmlData);\n                    }\n                });\n            }\n\n            /**\n             * This function print embed code for kaltura media.\n             */\n            function printHtmlCode() {\n                var selectedId = $(\"#code_type_select\").val();\n                var kalturaHost = $(\"#kalturahost\").val();\n                var partnerId = $(\"#partnerid\").val();\n                var uiconfId = $(\"#uiconfid\").val();\n                var playerstudio = $(\"#playerstudio\").val();\n                var entryId = $(\"#entryid\").val();\n                var now = Date.now();\n                var str = \"\";\n\n                if (selectedId == \"0\") {\n                    if (playerstudio == \"ovp\") {\n                        str += '<iframe type=\"text/javascript\" src=\"' + kalturaHost + '/p/' + partnerId;\n                        str += '/embedPlaykitJs/uiconfid/' + uiconfId;\n                        str += '?iframeembed=true&entry_id=' + entryId + '\" ';\n                        str += 'style=\"width: 560px; height: 395px\" ';\n                        str += 'allowfullscreen webkitallowfullscreen mozAllowFullScreen frameborder=\"0\" ';\n                        str += 'allow=\"encrypted-media\">';\n                        str += \"</iframe>\";\n                    } else {\n                        str += '<iframe src=\"' + kalturaHost + '/p/' + partnerId + '/sp/' + partnerId + '00';\n                        str += '/embedIframeJs/uiconf_id/' + uiconfId + '/partner_id/' + partnerId;\n                        str += '?iframeembed=true&playerId=kaltura_player_' + now;\n                        str += '&entry_id=' + entryId + '\" width=\"560\" height=\"395\" ';\n                        str += 'allowfullscreen webkitallowfullscreen mozAllowFullScreen frameborder=\"0\" ';\n                        str += 'allow=\"encrypted-media\"></iframe>';\n                    }\n                } else {\n                    str = kalturaHost + \"/index.php/extwidget/preview/partner_id/\";\n                    str += partnerId + \"/uiconf_id/\" + uiconfId + \"/entry_id/\" + entryId + \"/embed/dynamic?\";\n                }\n                $(\"#codearea\").val(str);\n            }\n\n            // Entry unload event callback.\n            $(window).on(\"unload\", function() {\n                sessionEnd();\n            });\n\n            // If window is resize, call modal window centerize function.\n            $(window).resize(centeringModalSyncer);\n\n            // Entry change event callback.\n            $(\"#access_control_select\").on(\"change\", function() {\n                selectedControl();\n            });\n\n            // Entry change event callback.\n            $(\"#code_type_select\").on(\"change\", function() {\n                printHtmlCode();\n            });\n\n            // Entry click event callback.\n            $(\"#access_media_save\").on(\"click\", function() {\n                updateAccessControlId();\n            });\n\n            printHtmlCode();\n        }\n    };\n});\n"],"names":["define","$","init","STATUS","centeringModalSyncer","w","window","width","h","height","cw","outerWidth","ch","outerHeight","css","left","top","fadeInModalWindow","this","blur","append","fadeIn","addBackButton","url","on","location","href","handleCancelClick","updateAccessControlId","entryStatus","findData","controlId","val","entryId","serverHost","ks","fd","FormData","postData","type","data","cache","async","contentType","scriptCharset","processData","dataType","serviceURL","ajax","done","xmlData","undefined","find","text","currentControl","resultId","require","str","notification","strings","key","component","get_strings","then","results","mymedia","prop","sessionEnd","setTimeout","replace","fail","exception","printErrorMessage","console","dir","message","printHtmlCode","selectedId","kalturaHost","partnerId","uiconfId","playerstudio","now","Date","resize","selectedControlId","currentControlId","newLabel","html"],"mappings":"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"}