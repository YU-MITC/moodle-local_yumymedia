{"version":3,"file":"accessrestriction.min.js","sources":["../src/accessrestriction.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * YU Kaltura \"My Media\" script for acecss restriction setting.\n *\n * @copyright (C) 2016-2025 Yamaguchi University (gh-cc@mlex.cc.yamaguchi-u.ac.jp)\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module local_yumymedia/accessrestriction\n */\n\ndefine(['jquery'], function($) {\n\n    return {\n        /**\n         * Initial function.\n         * @access public\n         */\n        init: function() {\n\n            var STATUS = {\n                ENTRY_ERROR_IMPORTING: -2,\n                ENTRY_ERROR_CONVERTING: -1,\n                ENTRY_IMPORT: 0,\n                ENTRY_PRECONVERT: 1,\n                ENTRY_READY: 2,\n                ENTRY_DELETED: 3,\n                ENTRY_PENDING: 4,\n                ENTRY_MODERATE: 5,\n                ENTRY_BLOCKED: 6,\n                ENTRY_NO_CONTENT: 7\n            };\n\n            /**\n             * This function centerize modal window.\n             */\n            function centeringModalSyncer() {\n\n                // Get width and height of window.\n                var w = $(window).width();\n                var h = $(window).height();\n\n                // Get width and height of content area.\n                var cw = $(\"#modal_content\").outerWidth();\n                var ch = $(\"#modal_content\").outerHeight();\n\n                // Execute centering.\n                $(\"#modal_content\").css({\"left\": ((w - cw) / 2) + \"px\", \"top\": ((h - ch) / 2) + \"px\"});\n            }\n\n            /**\n             * This function print modal window.\n             * @return {bool} - If modal window open, return true. Otherwise return false.\n             */\n            function fadeInModalWindow() {\n                // All contents in web page release focus.\n                $(this).blur();\n                // Precent dupulicate execute of modal window.\n                if ($(\"#modal_window\")[0]) {\n                    return false;\n                }\n\n                // Create modal window and a content area.\n                $(\"body\").append(\"<div id=\\\"modal_window\\\"></div>\");\n                $(\"#modal_window\").fadeIn(\"slow\");\n\n                // Centering content area.\n                centeringModalSyncer();\n                // Fade-in content area.\n                $(\"#modal_content\").fadeIn(\"slow\");\n                return true;\n            }\n\n            /**\n             * This is callback function whem cancel button is clicked.\n             * @param {string} url - URL of taget page.\n             */\n            function handleCancelClick(url) {\n                location.href = url;\n            }\n\n            /**\n             * This function add back button to modal window.\n             * @param {string} url - URL of target page.\n             */\n            function addBackButton(url) {\n                var contentHtml = \"<input type=button id=\\\"backToMymedia\\\" name=\\\"backToMymedia\\\" value=Back />\";\n                $(\"#modal_content\").append(contentHtml);\n                $(\"#backToMyMedia\").on(\"click\", function() {\n                    handleCancelClick(url);\n                });\n            }\n\n            /**\n             * This is callback function when access control setting is changed.\n             */\n            function selectedControl() {\n                require(['core/str', 'core/notification'], function(str, notification) {\n                    var strings = [\n                        {key: 'heading_access_control', component: 'local_yumymedia'},\n                        {key: 'accesscontrol_changed', component: 'local_yumymedia'}\n                    ];\n                    str.get_strings(strings).then(function(results) {\n                        var selectedControlId = $(\"#access_control_select\").val();\n                        var currentControlId = $(\"#currentcontrol\").val();\n\n                        var newLabel = results[0];\n\n                        if (selectedControlId != currentControlId) {\n                            newLabel = newLabel + \" <font color=\\\"red\\\">(\" + results[1] + \")</font>\";\n                            $(\"#access_media_save\").prop(\"disabled\", false);\n                        } else {\n                            $(\"#access_media_save\").prop(\"disabled\", true);\n                        }\n\n                        $(\"#access_control_label\").html(newLabel);\n                        return 0;\n                    }).fail(notification.exception);\n                });\n            }\n\n            /**\n             * This function update access control id.\n             */\n            function updateAccessControlId() {\n                var entryStatus;\n                var findData;\n\n                var controlId = $(\"#access_control_select\").val();\n                var entryId = $(\"#entryid\").val();\n                var serverHost = $(\"#kalturahost\").val();\n                var ks = $(\"#ks\").val();\n\n                // Create form data.\n                var fd = new FormData();\n                fd.append(\"action\", \"update\");\n                fd.append(\"ks\", ks);\n                fd.append(\"entryId\", entryId);\n                fd.append(\"baseEntry:accessControlId\", controlId);\n\n                // Create data is transmitted.\n                var postData = {\n                    type: \"POST\",\n                    data: fd,\n                    cache: false,\n                    async: true,\n                    contentType: false,\n                    scriptCharset: \"utf-8\",\n                    processData: false,\n                    dataType: \"xml\"\n                };\n\n                var serviceURL = serverHost + \"/api_v3/service/baseEntry/action/update\";\n\n                // Transmits data.\n                $.ajax(\n                   serviceURL, postData\n                )\n                .done(function(xmlData) {\n                    // When XML data is not received.\n                    if (xmlData === null || typeof xmlData === \"undefined\") {\n                        printErrorMessage(\"Update failed (Cannot get a XML response)\");\n                        return;\n                    }\n\n                    // Get a tag of error code.\n                    findData = $(xmlData).find(\"code\");\n                    // When error code exists.\n                    if (findData !== null && typeof findData !== \"undefined\" && findData.text() !== \"\") {\n                        printErrorMessage(\"Update failed (\" + findData.text() + \")\");\n                        return;\n                    }\n\n                    // Get a tag of status.\n                    findData = $(xmlData).find(\"status\");\n                    // Where tag of statis not exists.\n                    if (findData === null || typeof findData === \"undefined\" || findData.text() === \"\") {\n                        printErrorMessage(\"Update failed (Cannot get a baseEntry)\");\n                        return;\n                    }\n\n                    // Get status value.\n                    entryStatus = findData.text();\n                    // When updating of access control is failed.\n                    if (entryStatus != STATUS.ENTRY_READY && entryStatus != STATUS.ENTRY_PENDING &&\n                        entryStatus != STATUS.ENTRY_PRECONVERT) {\n                        printErrorMessage(\"Update failed (status of baseEntry: \" + entryStatus + \")\");\n                        return;\n                    }\n\n                    // Get a tag of access control.\n                    findData = $(xmlData).find(\"accessControlId\");\n                    // When tag of acecss control not exists.\n                    if (findData === null || typeof findData === \"undefined\" || findData.text() === \"\") {\n                        printErrorMessage(\"Update failed(Cannot get an accessControlId)\");\n                        return;\n                    }\n\n                    // Get a value of access control.\n                    var resultId = findData.text();\n                    // When updating of access control is failed.\n                    if (resultId != controlId) {\n                        printErrorMessage(\"Update failed(accessControlId: \" + resultId + \")\");\n                        return;\n                    }\n\n                    // Print a success message.\n                    printSuccessMessage(resultId);\n                })\n                .fail(function(xmlData) {\n                    if (xmlData !== null) {\n                        window.console.dir(xmlData);\n                    }\n                    printErrorMessage(\"Update fialed(Cannot connect to contents server)\");\n                    return;\n                });\n            }\n\n            /**\n             * This function print a success message.\n             * @param {string} currentControl - Label of current access control.\n             */\n            function printSuccessMessage(currentControl) {\n                require(['core/str', 'core/notification'], function(str, notification) {\n                    var strings = [\n                        {key: 'accesscontrol_updated', component: 'local_yumymedia'}\n                    ];\n                    str.get_strings(strings).then(function(results) {\n                        var mymedia = $(\"#mymedia\").val();\n                        $(\"#access_media_save\").prop(\"disabled\", true);\n                        $(\"#currentcontrol\").val(currentControl);\n\n                        // View modal window.\n                        fadeInModalWindow();\n                        // Append message to content area.\n                        $(\"#modal_content\").append(\"<p>\" + results[0] + \"</p><br>\");\n                        // Append back button to content area.\n                        addBackButton(mymedia);\n                        // Close session to kaltura server.\n                        sessionEnd();\n                        // Jump tp my media page.\n                        setTimeout(function() {\n                            window.location.replace(mymedia);\n                        }, 1000);\n                        return 0;\n                    }).fail(notification.exception);\n                });\n            }\n\n            /**\n             * This function print error message.\n             * @param {string} message - message string.\n             */\n            function printErrorMessage(message) {\n                var mymedia = $(\"#mymedia\").val();\n\n                // Create error message.\n                message = \"<p><font color=red>\" + message + \"</font></p><br>\";\n                // View modal window.\n                fadeInModalWindow();\n                // Append error message to content area.\n                $(\"#modal_content\").append(message);\n                // Append back buttion to content area.\n                addBackButton(mymedia);\n                // Close session to kaltura server.\n                sessionEnd();\n            }\n\n            /**\n             * This function close a session between client and kaltura server.\n             */\n            function sessionEnd() {\n                var serverHost = $(\"#kalturahost\").val();\n                var serviceURL = serverHost + \"/api_v3/service/session/action/end\";\n\n                // Transmit from data.\n                $.ajax({\n                    type: \"GET\",\n                    url: serviceURL,\n                    cache: false\n                })\n                .done(function(xmlData) {\n                    // When format of response is not XML.\n                    if (xmlData !== null) {\n                        window.console.dir(xmlData);\n                    }\n                })\n                .fail(function(xmlData) {\n                    if (xmlData !== null) {\n                        window.console.dir(xmlData);\n                    }\n                });\n            }\n\n            /**\n             * This function print embed code for kaltura media.\n             */\n            function printHtmlCode() {\n                var selectedId = $(\"#code_type_select\").val();\n                var kalturaHost = $(\"#kalturahost\").val();\n                var partnerId = $(\"#partnerid\").val();\n                var uiconfId = $(\"#uiconfid\").val();\n                var playerstudio = $(\"#playerstudio\").val();\n                var entryId = $(\"#entryid\").val();\n                var now = Date.now();\n                var str = \"\";\n\n                if (selectedId == \"0\") {\n                    if (playerstudio == \"ovp\") {\n                        str += '<iframe type=\"text/javascript\" src=\"' + kalturaHost + '/p/' + partnerId;\n                        str += '/embedPlaykitJs/uiconfid/' + uiconfId;\n                        str += '?iframeembed=true&entry_id=' + entryId + '\" ';\n                        str += 'style=\"width: 560px; height: 395px\" ';\n                        str += 'allowfullscreen webkitallowfullscreen mozAllowFullScreen frameborder=\"0\" ';\n                        str += 'allow=\"encrypted-media\">';\n                        str += \"</iframe>\";\n                    } else {\n                        str += '<iframe src=\"' + kalturaHost + '/p/' + partnerId + '/sp/' + partnerId + '00';\n                        str += '/embedIframeJs/uiconf_id/' + uiconfId + '/partner_id/' + partnerId;\n                        str += '?iframeembed=true&playerId=kaltura_player_' + now;\n                        str += '&entry_id=' + entryId + '\" width=\"560\" height=\"395\" ';\n                        str += 'allowfullscreen webkitallowfullscreen mozAllowFullScreen frameborder=\"0\" ';\n                        str += 'allow=\"encrypted-media\"></iframe>';\n                    }\n                } else {\n                    str = kalturaHost + \"/index.php/extwidget/preview/partner_id/\";\n                    str += partnerId + \"/uiconf_id/\" + uiconfId + \"/entry_id/\" + entryId + \"/embed/dynamic?\";\n                }\n                $(\"#codearea\").val(str);\n            }\n\n            // Entry unload event callback.\n            $(window).on(\"unload\", function() {\n                sessionEnd();\n            });\n\n            // If window is resize, call modal window centerize function.\n            $(window).resize(centeringModalSyncer);\n\n            // Entry change event callback.\n            $(\"#access_control_select\").on(\"change\", function() {\n                selectedControl();\n            });\n\n            // Entry change event callback.\n            $(\"#code_type_select\").on(\"change\", function() {\n                printHtmlCode();\n            });\n\n            // Entry click event callback.\n            $(\"#access_media_save\").on(\"click\", function() {\n                updateAccessControlId();\n            });\n\n            printHtmlCode();\n        }\n    };\n});\n"],"names":["define","$","init","STATUS","centeringModalSyncer","w","window","width","h","height","cw","outerWidth","ch","outerHeight","css","fadeInModalWindow","this","blur","append","fadeIn","addBackButton","url","on","location","href","handleCancelClick","updateAccessControlId","entryStatus","findData","controlId","val","entryId","serverHost","ks","fd","FormData","postData","type","data","cache","async","contentType","scriptCharset","processData","dataType","serviceURL","ajax","done","xmlData","find","text","currentControl","resultId","require","str","notification","strings","key","component","get_strings","then","results","mymedia","prop","sessionEnd","setTimeout","replace","fail","exception","printErrorMessage","console","dir","message","printHtmlCode","selectedId","kalturaHost","partnerId","uiconfId","playerstudio","now","Date","resize","selectedControlId","currentControlId","newLabel","html"],"mappings":"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"}