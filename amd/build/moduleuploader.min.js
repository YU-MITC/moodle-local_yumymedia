/**
 * Uploader Script used in resource and activirty modules.
 *
 * @copyright (C) 2016-2023 Yamaguchi University (gh-cc@mlex.cc.yamaguchi-u.ac.jp)
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_yumymedia/moduleuploader",["jquery"],(function($){return{init:function(){var contentPanel,timer=!1,fileName="",fileSize=0,MEDIA_TYPE_VIDEO=1,MEDIA_TYPE_IMAGE=2,MEDIA_TYPE_AUDIO=5,AUTO_FINALIZE_NULL=-1,ENTRY_STATUS={ENTRY_IMPORTING:-2,ENTRY_CONVERTING:-1,ENTRY_IMPORT:0,ENTRY_PRECONVERT:1,ENTRY_READY:2,ENTRY_DELETED:3,ENTRY_PENDING:4,ENTRY_MODERATE:5,ENTRY_BLOCKED:6,ENTRY_NO_CONTENT:7},UPLOAD_TOKEN_STATUS_PENDING=0,UPLOAD_TOKEN_STATUS_PARTIAL_UPLOAD=1,UPLOAD_TOKEN_STATUS_FULL_UPLOAD=2;function fadeOutUploaderWindow(){window.scrollTo(0,0),$("#modal_window",parent.document).fadeOut("slow"),$("#modal_window",parent.document).remove(),$("#uploader_content",parent.document).fadeOut("slow"),$("#uploader_content",parent.document).remove()}function checkForm(){null===$("#fileData")||null===$("#fileData").files||""===$("#name").val()||""===$("#tags").val()||""===$("#type").val()||"N/A"===$("#type").val()?($("#entry_submit").prop("disabled",!0),$("#entry").val("")):$("#entry_submit").prop("disabled",!1)}function checkFileSize(){return!(fileSize<=0)&&!(fileSize>2e9)}function checkNameString(str){return!0!==/["$%&'~^\\`/]/.test(str)}function handleSubmitClick(){return!1!==(nameStr=$("#name").val(),tagsStr=$("#tags").val(),descStr=$("#description").val(),flag=!0,!1===checkNameString(nameStr)&&(require(["core/str"],(function(str){var message=str.get_string("wrong_name","local_yumymedia",null);$.when(message).done((function(localizedString){window.alert(localizedString)}))})),flag=!1),0==(!0!==/[!"#$%&'~|^\\@`()[\]{}:;+*/=<>?]/.test(tagsStr))&&(require(["core/str"],(function(str){var message=str.get_string("wrong_tags","local_yumymedia",null);$.when(message).done((function(localizedString){window.alert(localizedString)}))})),flag=!1),!1===checkNameString(descStr)&&(require(["core/str"],(function(str){var message=str.get_string("wrong_desc","local_yumymedia",null);$.when(message).done((function(localizedString){window.alert(localizedString)}))})),flag=!1),flag)&&(!1===checkFileSize()?(require(["core/str"],(function(str){var message=str.get_string("wrong_filesize","local_yumymedia",null);$.when(message).done((function(localizedString){window.alert(localizedString)}))})),!1):($("#entry_submit").prop("disabled",!0),serverHost=$("#kalturahost").val(),ks=$("#ks").val(),function(serverHost,ks){var uploadTokenId,findData,file=$("#fileData").prop("files")[0];fileSize=parseInt(encodeURI(file.size));var postData={type:"GET",cache:!1,async:!0,contentType:!1,scriptCharset:"utf-8",dataType:"xml"},serviceURL=serverHost+"/api_v3/service/uploadToken/action/add?ks="+ks;serviceURL=(serviceURL=(serviceURL=(serviceURL+="&uploadToken:objectType=KalturaUploadToken")+"uploadToken:fileName="+encodeURI(fileName))+"&uploadToken:fileSize="+fileSize)+"&uploadToken:autoFinalize="+AUTO_FINALIZE_NULL,$.ajax(serviceURL,postData).done((function(xmlData){if(null!==xmlData)if(null===(findData=$(xmlData).find("code"))||void 0===typeof findData||""===findData.text())if(null!==(findData=$(xmlData).find("status"))&&void 0!==typeof findData&&""!==findData.text()){var uploadTokenStatus=findData.text();uploadTokenStatus==UPLOAD_TOKEN_STATUS_PENDING?null!==(findData=$(xmlData).find("id"))&&void 0!==typeof findData&&""!==findData.text()?(uploadTokenId=findData.text(),setTimeout((function(){!function(serverHost,ks,uploadTokenId){var findData,entryStatus,entryId="",entryName="",entryTags="",entryDescription="",entryCreatorId="",nameStr=$("#name").val(),tagsStr=$("#tags").val(),descStr=$("#description").val(),controlId=$("#controlId").val(),creatorId=$("#creatorId").val();nameStr=nameStr.trim(),tagsStr=tagsStr.trim(),null!==descStr&&(descStr=descStr.trim());var fd=new FormData;fd.append("action","add"),fd.append("ks",ks),fd.append("entry:objectType","KalturaMediaEntry");var type=$("#type").val(),mediaType="";mediaType="image"==type?MEDIA_TYPE_IMAGE:"audio"==type?MEDIA_TYPE_AUDIO:MEDIA_TYPE_VIDEO,fd.append("entry:mediaType",mediaType),fd.append("entry:sourceType",1),fd.append("entry:name",nameStr),fd.append("entry:tags",tagsStr),null!==descStr&&""!==descStr?fd.append("entry:description",descStr):fd.append("entry:description",""),fd.append("entry:categories",$("#categories").val()),null!==controlId&&""!==controlId&&fd.append("entry:accessControlId",controlId),fd.append("entry:creatorId",creatorId),fd.append("entry:userId",creatorId);var postData={type:"POST",data:fd,cache:!1,async:!0,contentType:!1,scriptCharset:"utf-8",processData:!1,dataType:"xml"},serviceURL=serverHost+"/api_v3/service/media/action/add";$.ajax(serviceURL,postData).done((function(xmlData){return null===xmlData||void 0===typeof xmlData?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot create media entry !<br>(Cannot get a XML response.)")):null!==(findData=$(xmlData).find("code"))&&void 0!==typeof findData&&""!==findData.text()?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot create media entry !<br>("+findData.text()+")")):null===(findData=$(xmlData).find("status"))||void 0===typeof findData||""===findData.text()?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot create media entyry !<br>(Cannot get a mediaEntryStatus.)")):(entryStatus=findData.text())!=ENTRY_STATUS.ENTRY_NO_CONTENT?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot create media entry!<br>(mediaEntryStatus: "+entryStatus+")")):(findData=$(xmlData).find("id"),entryId=findData.text(),findData=$(xmlData).find("name"),entryName=findData.text(),findData=$(xmlData).find("tags"),entryTags=findData.text(),findData=$(xmlData).find("description"),entryDescription=null!==findData&&void 0!==typeof findData&&""!==findData.text()?findData.text():"",findData=$(xmlData).find("creatorId"),entryCreatorId=findData.text(),null===entryId||""===entryId||null===entryName||""===entryName||null===entryTags||""===entryTags||null===entryCreatorId||""===entryCreatorId||""!==descStr&&(null===entryDescription||""===entryDescription)?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("There exists wrong information(s) <br>")):void setTimeout((function(){!function(serverHost,ks,uploadTokenId,entryId){var findData,fd=new FormData;require(["core/str","core/notification"],(function(str,notification){var strings=[{key:"uploader_uploading",component:"local_yumymedia"},{key:"progress",component:"local_yumymedia"},{key:"attach_file",component:"local_yumymedia"}];str.get_strings(strings).then((function(results){fd.append("action","upload"),fd.append("ks",ks),fd.append("uploadTokenId",uploadTokenId),fd.append("fileData",$("input[name='fileData']").prop("files")[0],encodeURI(fileName),fileSize),fd.append("resume",!1),fd.append("finalChunk",!0),fd.append("resumeAt",0);var postData={type:"POST",data:fd,cache:!1,async:!0,contentType:!1,scriptCharset:"utf-8",processData:!1,dataType:"xml",xhr:function(){var XHR=$.ajaxSettings.xhr();return XHR.upload&&XHR.upload.addEventListener("progress",(function(e){var newValue=parseInt(e.loaded/e.total*100);$("#pvalue").html(parseInt(newValue))}),!1),XHR}};$("#upload_info").html(""),$("#upload_info").append(results[0]+"<br>");var message="<p>"+results[1];message+=': <span id="pvalue" style="color:#00b200">0.00</span> %</p>',$("#upload_info").append(message);var serviceURL=serverHost+"/api_v3/service/uploadToken/action/upload";return $.ajax(serviceURL,postData).done((function(xmlData){if(null===xmlData)return deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot upload the video !<br>(Cannot get a XML response.)");if(null!==(findData=$(xmlData).find("code"))&&void 0!==typeof findData&&""!==findData.text())return deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot upload the video !<br>("+findData.text()+")");if(null===(findData=$(xmlData).find("status"))||void 0===typeof findData||""===findData.text())return deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot upload the video !<br>(Cannot get an uploadTokenStatus.)");var uploadTokenStatus=findData.text();if(uploadTokenStatus!=UPLOAD_TOKEN_STATUS_FULL_UPLOAD&&uploadTokenStatus!=UPLOAD_TOKEN_STATUS_PARTIAL_UPLOAD)return deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot upload the video !<br>(UPLOAD_TOKEN_STATUS : "+uploadTokenStatus+")");window.console.log("File chunk have been transmitted."),$("#upload_info").append(results[2]+"<br>"),setTimeout((function(){!function(serverHost,ks,uploadTokenId,entryId){var entryStatus,findData,entryName="",entryTags="",entryDescription="",entryCreatorId="",fd=new FormData;fd.append("action","addContent"),fd.append("ks",ks),fd.append("entryId",entryId),fd.append("resource:objectType","KalturaUploadedFileTokenResource"),fd.append("resource:token",uploadTokenId);var postData={type:"POST",data:fd,cache:!1,async:!0,contentType:!1,scriptCharset:"utf-8",processData:!1,dataType:"xml"},serviceURL=serverHost+"/api_v3/service/media/action/addContent";$.ajax(serviceURL,postData).done((function(xmlData){return null===xmlData||void 0===typeof xmlData?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot attach uploaded file !<br>(Cannot get a XML response.)")):null!==(findData=$(xmlData).find("code"))&&void 0!==typeof findData&&""!==findData.text()?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot attach uploaded file !<br>("+findData.text()+")")):null===(findData=$(xmlData).find("status"))||void 0===typeof findData||""===findData.text()?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot attach uploaded file !<br>(Cannot get a mediaEntryStatus.)")):(entryStatus=findData.text())!=ENTRY_STATUS.ENTRY_READY&&entryStatus!=ENTRY_STATUS.ENTRY_PENDING&&entryStatus!=ENTRY_STATUS.ENTRY_PRECONVERT&&entryStatus!=ENTRY_STATUS.IMPORT&&entryStatus!=ENTRY_STATUS.IMPORTING?(deleteUploadToken(serverHost,ks,uploadTokenId),void printErrorMessage("Cannot attach uploaded file !<br>(mediaEntryStatus: "+entryStatus+")")):(findData=$(xmlData).find("id"),entryId=findData.text(),findData=$(xmlData).find("name"),entryName=findData.text(),findData=$(xmlData).find("tags"),entryTags=findData.text(),findData=$(xmlData).find("description"),entryDescription=null!==findData&&void 0!==typeof findData&&""!==findData.text()?findData.text():"",findData=$(xmlData).find("creatorId"),entryCreatorId=findData.text(),function(id,name,tags,description,creatorId){var output="<h3>Your upload has been suceeded !</h3>";output+='<table border="2" cellpadding="5">',output+="<tr><td>entry id</td><td>"+id+"</td></tr>",output+="<tr><td>name</td><td>"+name+"</td></tr>",output+="<tr><td>tags</td><td>"+tags+"</td></tr>",output+="<tr><td>description</td><td>"+description+"</td></tr>",output+="<tr><td>creator id</td><td>"+creatorId+"</td></tr>",output+="</table>",output+="<br>",output+='<input type=button id="backToMymedia" name="backToMymedia" value="Back" />',$("#upload_info").html(output),$("#backToMymedia").on("click",(function(){fadeOutUploaderWindow()})),require(["core/str","core/notification"],(function(str,notification){var strings=[{key:"upload_success",component:"local_yumymedia"},{key:"entryid_header",component:"local_yumymedia"},{key:"name_header",component:"local_yumymedia"},{key:"tags_header",component:"local_yumymedia"},{key:"desc_header",component:"local_yumymedia"},{key:"creatorid_header",component:"local_yumymedia"},{key:"back_label",component:"local_yumymedia"}];str.get_strings(strings).then((function(results){var output="<h3>"+results[0]+"</h3>";return output+='<table border="2" cellpadding="5">',output+="<tr><td>"+results[1]+"</td><td>"+id+"</td></tr>",output+="<tr><td>"+results[2]+"</td><td>"+name+"</td></tr>",output+="<tr><td>"+results[3]+"</td><td>"+tags+"</td></tr>",output+="<tr><td>"+results[4]+"</td><td>"+description+"</td></tr>",output+="<tr><td>"+results[5]+"</td><td>"+creatorId+"</td></tr>",output+="</table>",output+="<br>",output+='<input type=button id="backToMymedia" name="backToMymedia" value="',output+=results[6]+'" />',$("#upload_info").html(output),$("#backToMymedia").on("click",(function(){fadeOutUploaderWindow()})),0})).fail(notification.exception)}))}(entryId,entryName,entryTags,entryDescription,entryCreatorId),void function(serverHost,id,name,description){if(null!==id&&""!==id){null!==id&&$("#entry_id",parent.document).val(id);var idName=$("#id_name",parent.document);null!==idName&&idName.val(name),null!==description&&(description=description.replace(/\n/g,"<br />")),description="<p>"+description+"<br /></p>";var editor=$("#id_introeditoreditable",parent.document);null!==editor&&(null!==description&&""!==description?editor.html(description):editor.html("")),null!==(editor=$("#id_introeditor",parent.document))&&(null!==description&&""!==description?editor.html(description):editor.html(""));var partnerid=$("#partner_id",parent.document).val(),source=serverHost+"/p/"+partnerid+"/sp/"+partnerid+"00/thumbnail/entry_id/"+id;source+="/width/150/height/100/type/3";var idMediaThumbnail=$("#media_thumbnail",parent.document);null!==idMediaThumbnail&&(idMediaThumbnail.prop("src",source),idMediaThumbnail.prop("alt",name),idMediaThumbnail.prop("title",name));var idMediaProperties=$("#id_media_properties",parent.document);null!==idMediaProperties&&idMediaProperties.css({visibility:"visible"});var submitMedia=$("#submit_media",parent.document);null!==submitMedia&&submitMedia.prop("disabled",!1)}}(serverHost,entryId,entryName,entryDescription))})).fail((function(xmlData){null!==xmlData&&window.console.dir(xmlData),deleteUploadToken(serverHost,ks,uploadTokenId),printErrorMessage("Cannot attach uploaded file !<br>(Cannot connect to kaltura server.)")}))}(serverHost,ks,uploadTokenId,entryId)}),1e3)})).fail((function(xmlData){null!==xmlData&&window.console.dir(xmlData),deleteUploadToken(serverHost,ks,uploadTokenId),printErrorMessage("Cannot upload the file !<br>(Cannot connect to contents server.)")})),0})).fail(notification.exception)}))}(serverHost,ks,uploadTokenId,entryId)}),50))})).fail((function(xmlData){null!==xmlData&&window.console.dir(xmlData),deleteUploadToken(serverHost,ks,uploadTokenId),printErrorMessage("Cannot create media entry !<br>(Cannot connect to kaltura server.)")}))}(serverHost,ks,uploadTokenId)}),50)):printErrorMessage("Cannot create uplaod token !<br>(Cannot get an uploadTokenId.)"):printErrorMessage("Cannot create upload token !<br>(UPLOAD_TOKEN_STATUS : "+uploadTokenStatus+")")}else printErrorMessage("Cannot create upload token !<br>(Cannot get status of upload token.)");else printErrorMessage("Cannot create upload token !<br>("+findData.text()+")");else printErrorMessage("Cannot create upload token !<br>(Cannot get a XML response.)")})).fail((function(xmlData){null!==xmlData&&window.console.dir(xmlData),printErrorMessage("Cannot create upload token !<br>(Cannot connect to kaltura server.)")}))}(serverHost,ks),!0));var nameStr,tagsStr,descStr,flag,serverHost,ks}function printErrorMessage(errorMessage,ks,uploadTokenId){""!==ks&&""!==uploadTokenId&&deleteUploadToken(),$("#upload_info").html(""),$("#upload_info").append('<font color="red">'+errorMessage+"</font><br>"),require(["core/str"],(function(str){var message=str.get_string("back_label","local_yumymedia",null);$.when(message).done((function(localizedString){var contentHtml='<br><input type=button id="backToMymedia" name="backToMymedia" value="';contentHtml+=localizedString+'" />',$("#upload_info").append(contentHtml),$("#backToMymedia").on("click",(function(){fadeOutUploaderWindow()}))}))}))}function deleteUploadToken(serverHost,ks,uploadTokenId){var flag,fd=new FormData;fd.append("action","delete"),fd.append("ks",ks),fd.append("uploadTokenId",uploadTokenId);var postData={type:"POST",data:fd,cache:!1,contentType:!1,scriptCharset:"utf-8",processData:!1,async:!0,dataType:"xml"},serviceURL=serverHost+"/api_v3/service/uploadToken/action/delete";return $.ajax(serviceURL,postData).done((function(xmlData){null===xmlData&&(flag=!1),flag=!0})).fail((function(xmlData){flag=!1,null!==xmlData&&window.console.dir(xmlData)})),flag}$(window).on("change",(function(){checkForm()})),$(window).on("unload",(function(){var serviceURL;serviceURL=$("#kalturahost").val()+"/api_v3/service/session/action/end",$.ajax({type:"GET",url:serviceURL,cache:!1}).done((function(xmlData){null===xmlData?window.console.log("Cannot delete the uploadToken ! (Cannot get a XML response.)"):window.console.log("Kaltura Session has been deleted.")})).fail((function(xmlData){window.console.log("Cannot delete the uploadToken ! (Cannot connect to content server.)"),null!==xmlData&&window.console.dir(xmlData)}))})),$(window).resize((contentPanel="#uploader_content",!1!==timer&&clearTimeout(timer),void(timer=setTimeout((function(){var w=$(window).width(),h=$(window).height(),cw=$(contentPanel).outerWidth(),ch=$(contentPanel).outerHeight();$(contentPanel).css({left:(w-cw)/2+"px",top:(h-ch)/2+"px"})}),200)))),$("#fileData").on("change",(function(){!function(){var fileType,alertInfo="";if($("#fileData")){var file=$("#fileData").prop("files")[0];fileSize=parseInt(file.size);var typeResult=-1!=(fileType=encodeURI(file.type)).indexOf("video/avi")||-1!=fileType.indexOf("video/x-msvideo")||-1!=fileType.indexOf("video/mpeg")||-1!=fileType.indexOf("video/mpg")||-1!=fileType.indexOf("video/mp4")||-1!=fileType.indexOf("video/ogg")||-1!=fileType.indexOf("video/quicktime")||-1!=fileType.indexOf("video/VP8")||-1!=fileType.indexOf("video/x-flv")||-1!=fileType.indexOf("video/x-f4v")||-1!=fileType.indexOf("video/x-matroska")||-1!=fileType.indexOf("video/x-ms-wmv")||-1!=fileType.indexOf("video/webm")?"video":-1!=fileType.indexOf("audio/ac3")||-1!=fileType.indexOf("audio/ogg")||-1!=fileType.indexOf("audio/mpeg")||-1!=fileType.indexOf("audio/mp4")||-1!=fileType.indexOf("audio/mp3")||-1!=fileType.indexOf("audio/wav")||-1!=fileType.indexOf("audio/x-ms-wma")?"audio":-1!=fileType.indexOf("image/gif")||-1!=fileType.indexOf("image/jpeg")||-1!=fileType.indexOf("image/png")||-1!=fileType.indexOf("image/tiff")?"image":"N/A",sizeResult=checkFileSize();require(["core/str","core/notification"],(function(str,notification){str.get_strings([{key:"wrong_filesize",component:"local_yumymedia"},{key:"unsupported_filetype",component:"local_yumymedia"},{key:"filesize",component:"local_yumymedia"},{key:"mimetype",component:"local_yumymedia"}]).then((function(results){if(!1===sizeResult&&(alertInfo+=results[0]),"N/A"==typeResult&&(alertInfo+=results[1]),""!==alertInfo)window.alert(alertInfo),$("#file_info").html(""),$("#name").val(""),$("#tags").val(""),$("#description").val(""),$("#type").val(""),$("#fileData").val("");else{var fileInfo="",sizeStr="";fileName=file.name,sizeStr=fileSize>1073741824?(fileSize/1073741824).toFixed(2)+" G":fileSize>1048576?(fileSize/1048576).toFixed(2)+" M":fileSize>1024?(fileSize/1024).toFixed(2)+" k":fileSize+" ",fileInfo+="<div id=metadata_fields>",fileInfo+=results[2]+": "+sizeStr+"bytes<br>",fileInfo+=results[3]+":"+encodeURI(file.type)+"<br>",fileInfo+="</div><hr>",$("#file_info").html(fileInfo),$("#name").val(fileName),$("#type").val(typeResult)}return checkForm(),0})).fail(notification.exception)}))}}()})),$("#name").on("change",(function(){checkForm()})),$("#tags").on("change",(function(){checkForm()})),$("#entry_submit").on("click",(function(){handleSubmitClick()})),$("#uploader_cancel").on("click",(function(){fadeOutUploaderWindow()})),$("#entry_reset").on("click",(function(){$("#file_info").html(""),$("#type").val("")})),$("#fadeout").on("click",(function(){fadeOutUploaderWindow()}))}}}));

//# sourceMappingURL=moduleuploader.min.js.map