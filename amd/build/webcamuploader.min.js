define(["jquery"],function(a){return{init:function(){function b(b){var c='<video id="webcam" width="'+F+'" height="'+G+'" ';c=c+'src="'+b+'" autoplay="false" oncontextmenu="return false;" controls></video>',a("#videospan").html(c),document.getElementById("webcam").pause(),document.getElementById("webcam").currentTime=0}function c(b){var c='<video id="webcam" width="'+F+'" height="'+G+'" ';c+='autoplay="0" muted oncontextmenu="return false;"></video>',a("#videospan").html(c),a("#webcam").attr("src",b)}function d(){a("#recstop").attr("src",a("#stopurl").val()),a("#recstop").off("click"),a("#recstop").on("click",function(){e()}),a("#leftspan").css("display","inline"),a("#webcam").volume=0,K.start(),a("#status").html('<font color="red">Now, recording...</font>')}function e(){K.ondataavailable=function(c){I=new Blob([c.data],{type:c.data.type}),J=M(I),b(J),C=I.size;var d="";C>1073741824?(C/=1073741824,d=C.toFixed(2)+" G"):C>1048576?(C/=1048576,d=C.toFixed(2)+" M"):C>1024?(C/=1024,d=C.toFixed(2)+" k"):d=C+" ",a("#status").html('<font color="green">Video preview ('+I.type+", "+d+"B).</font>"),E=i(I.type),D=h(),D===!1&&window.alert("Wrong file size."),j()},K.stop(),a("#leftspan").css("display","none"),a("#rightspan").css("display","inline"),a("#remove").on("click",function(){f()})}function f(){var b="";navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;try{if(null===navigator.getUserMedia||void 0===navigator.getUserMedia||null===MediaRecorder||void 0===MediaRecorder)return b='<font color="red">This uploader requires the WebRTC.<br>',b+="Howerver, your web browser don't support the WebRTC.</font>",void a("#message").html(b)}catch(e){return b='<font color="red">This uploader requires the WebRTC.<br>',b+="Howerver, your web browser don't support the WebRTC.</font>",void a("#message").html(b)}try{if(null===M||void 0===M||null===N||void 0===N)return b='<font color="red">This uploader requires the createObjectURL/revokeObjectURL.<br>',b+="Howerver, your web browser don't support these function.</font>",void a("#message").html(b)}catch(e){return b='<font color="red">This uploader requires the WebRTC.<br>',b+="Howerver, your web browser don't support the WebRTC.</font>",void a("#message").html(b)}c(null),null!==J&&(N(J),J=null,I=null),null!==H&&void 0!==H.stop&&H.stop(),C=0,D=!1,E="",a("#recstop").off("click"),a("#remove").off("click"),a("#webcam").off("ondataavailable");var f="";f=MediaRecorder.isTypeSupported("video/webm;codecs=vp9")?"video/webm; codecs=vp8":MediaRecorder.isTypeSupported("video/webm;codecs=vp8")?"video/webm; codecs=vp9":MediaRecorder.isTypeSupported("video/webm")?"video/webm":"video/mp4",L={audioBitsPerSecond:128e3,videoBitsPerSecond:15e5,mimeType:f,audio:{echoCancellation:!1},video:{mandatory:{minWidth:320,minHeight:240,maxWidth:1280,maxHeight:720,minFrameRate:5,maxFrameRate:15},optional:[{facingMode:"user"}]}},navigator.getUserMedia(L,function(b){H=b,J=M(H),a("#webcam").attr("src",J),window.console.log(H),K=new MediaRecorder(H,L),a("#recstop").attr("src",a("#recurl").val()),a("#recstop").on("click",function(){d()}),a("#leftspan").css("display","inline"),a("#rightspan").css("display","none"),a("#status").html("Camera preview.")},function(b){var c='<font color="red">Your webcamera is not supported, ';c+="or the webcamera is already used.</font>",a("#message").html(c),window.console.log(b.name+": "+b.message)}),j()}function g(){var b=a(window).width(),c=a(window).height(),d=a("#modal_content").outerWidth(),e=a("#modal_content").outerHeight();a("#modal_content").css({left:(b-d)/2+"px",top:(c-e)/2+"px"})}function h(){return 0>=C?!1:C>2e9?!1:!0}function i(a){return-1!=a.indexOf("video/avi")||-1!=a.indexOf("video/x-msvideo")||-1!=a.indexOf("video/mpeg")||-1!=a.indexOf("video/mpg")||-1!=a.indexOf("video/mp4")||a.indexOf("video/ogg")||-1!=a.indexOf("video/quicktime")||-1!=a.indexOf("video/VP8")||-1!=a.indexOf("video/x-flv")||-1!=a.indexOf("video/x-f4v")||-1!=a.indexOf("video/x-matroska")||-1!=a.indexOf("video/x-ms-wmv")||-1!=a.indexOf("video/webm")?"video":-1!=a.indexOf("audio/ac3")||-1!=a.indexOf("audio/ogg")||-1!=a.indexOf("audio/mpeg")||-1!=a.indexOf("audio/mp4")||-1!=a.indexOf("audio/wav")||-1!=a.indexOf("audio/x-ms-wma")?"audio":-1!=a.indexOf("image/gif")||-1!=a.indexOf("image/jpeg")||-1!=a.indexOf("image/png")||-1!=a.indexOf("image/tiff")?"image":"N/A"}function j(){null===J||null===I||0===I.size||D===!1||""===a("#name").val()||""===a("#tags").val()||""===E||"N/A"===E?(a("#entry_submit").prop("disabled",!0),a("#entry").val("")):a("#entry_submit").prop("disabled",!1)}function k(){location.href="./yumymedia.php"}function l(){if(a(this).blur(),a("#modal_window")[0])return!1;var b=document.documentElement,c=document.body;return A=b.scrollLeft||c.scrollLeft,B=b.scrollTop||c.scrollTop,a("body").append('<div id="modal_window"></div>'),a("#modal_window").fadeIn("slow"),g(),a("#modal_content").fadeIn("slow"),!0}function m(){window.scrollTo(A,B),a("#modal_content,#modal_window").fadeOut("slow",function(){a("#modal_window").remove(),a("#modal_content").remove()})}function n(){var b='<br><input type=button id="backToMymedia" name="backToMymedia" value="Back" />';a("#modal_content").append(b),a("#backToMymedia").on("click",function(){k()})}function o(b){a("#modal_content").append('<font color="red">'+b+"</font><br>"),n()}function p(b,c,d,e,f){m();var g="<h3>Your upload has been suceeded !</h3>";g+='<table border="2" cellpadding="5">',g+="<tr><td>entry id</td><td>"+b+"</td></tr>",g+="<tr><td>name</td><td>"+c+"</td></tr>",g+="<tr><td>tags</td><td>"+d+"</td></tr>",g+="<tr><td>description</td><td>"+e+"</td></tr>",g+="<tr><td>creator id</td><td>"+f+"</td></tr>",g+="</table>",g+="<br>",g+='<input type=button id="backToMymedia" name="backToMymedia" value="Back" />',a("#upload_info").html(g),a("#backToMymedia").on("click",function(){k()})}function q(){a("#file_info").html(""),a("#type").val("")}function r(a){var b=/["$%&'~\^\\`\/]/;return b.test(a)===!0?!1:!0}function s(a){var b=/[!"#$%&'~\|\^\\@`()\[\]\{\}:;\+\*\/=<>?]/;return b.test(a)===!0?!1:!0}function t(){var b=a("#name").val(),c=a("#tags").val(),d=a("#description").val();return r(b)===!1?(window.alert("There is wrong letter(s) in <Name>."),!1):s(c)===!1?(window.alert("There is wrong letter(s) in <Tags>."),!1):r(d)===!1?(window.alert("There is wrong letter(s) in <Description>."),!1):!0}function u(){return t()===!1?(window.alert("Wrong metadata."),!1):h()===!1?(window.alert("Wrong file size."),!1):(l(),v(),!0)}function v(){var b=a("#kalturahost").val(),c=a("#ks").val();x(b,c)}function w(b,c,d){var e,f=new FormData;f.append("action","delete"),f.append("ks",c),f.append("uploadTokenId",d);var g={type:"POST",data:f,cache:!1,contentType:!1,scriptCharset:"utf-8",processData:!1,async:!0,dataType:"xml"},h=b+"/api_v3/service/uploadToken/action/delete";return a.ajax(h,g).done(function(a){null===a&&(e=!1),e=!0}).fail(function(a){e=!1,null!==a&&window.console.dir(a)}),e}function x(b,c){var d,e,f=new FormData;f.append("action","upload"),f.append("fileData",I),f.append("ks",c);var g={type:"POST",data:f,cache:!1,async:!0,contentType:!1,scriptCharset:"utf-8",processData:!1,dataType:"xml",xhr:function(){var b=a.ajaxSettings.xhr();return b.upload&&b.upload.addEventListener("progress",function(b){var c=parseInt(b.loaded/b.total*1e4)/100;a("#pvalue").html(parseInt(c))},!1),b}},h=b+"/api_v3/service/media/action/upload";a("#modal_content").append("Uploading a media file ...<br>"),a("#modal_content").append('<p>Progress: <span id="pvalue" style="color:#00b200">0.00</span> %</p>'),a.ajax(h,g).done(function(f,g,h){return null===f?(w(b,c,d),void o("Cannot upload the file !<br>(Cannot get a XML response.)")):(e=a(f).find("code"),null!==e&&void 0!==typeof e&&""!==e.text()?void o("Cannot upload the file !<br>("+e.text()+")"):(e=a(f).find("result"),null===e||void 0===typeof e||""===e.text()?void o("Cannot upload the file !<br>(Cannot get an uploadTokenId.)"):(d=e.text(),a("#modal_content").append("Uploading an attirbute information ...<br>"),void setTimeout(function(){y(b,c,d)},1e3))))}).fail(function(a){w(b,c,d),null!==a&&window.console.dir(a),o("Cannot upload the file !<br>(Cannot connect to content server.)")})}function y(b,c,d){var e,f,g="",h="",i="",j="",k="",l=a("#type").val(),m="";m="image"==l?O.IMAGE:"audio"==l?O.AUDIO:O.VIDEO;var q=a("#name").val(),r=a("#tags").val(),s=a("#description").val(),t=a("#controlId").val();q=q.trim(),r=r.trim(),null!==s&&(s=s.trim());var u=new FormData;u.append("action","addFromUploadedFile"),u.append("ks",c),u.append("uploadTokenId",d),u.append("mediaEntry:name",q),u.append("mediaEntry:tags",r),null!==s&&""!==s?u.append("mediaEntry:description",s):u.append("mediaEntry:description",""),u.append("mediaEntry:categories",a("#categories").val()),u.append("mediaEntry:creatorId",a("#creatorId").val()),u.append("mediaEntry:userId",a("#creatorId").val()),u.append("mediaEntry:mediaType",m),u.append("mediaEntry:accessControlId",t);var v={type:"POST",data:u,cache:!1,async:!0,contentType:!1,scriptCharset:"utf-8",processData:!1,dataType:"xml"},x=b+"/api_v3/service/media/action/addFromUploadedFile";a.ajax(x,v).done(function(l){return null===l||void 0===typeof l?(w(b,c,d),void o("Cannot upload the attribute information !<br>(Cannot get a XML response.)")):(e=a(l).find("code"),null!==e&&void 0!==typeof e&&""!==e.text()?(w(b,c,d),void o("Cannot upload the attribute information !<br>("+e.text()+")")):(e=a(l).find("status"),null===e||void 0===typeof e||""===e.text()?(w(b,c,d),void o("Cannot upload the attribute information !<br>(Cannot get a mediaEntryStatus.)")):(f=e.text(),f!=P.ENTRY_READY&&f!=P.ENTRY_PENDING&&f!=P.ENTRY_PRECONVERT?(w(b,c,d),void o("Cannot upload the attribute information !<br>(mediaEntryStatus: "+f+")")):(e=a(l).find("id"),g=e.text(),e=a(l).find("name"),h=e.text(),e=a(l).find("tags"),i=e.text(),e=a(l).find("description"),j=null!==e&&void 0!==typeof e&&""!==e.text()?e.text():"",e=a(l).find("creatorId"),k=e.text(),n(),void p(g,h,i,j,k)))))}).fail(function(a){w(b,c,d),null!==a&&window.console.dir(a),o("Cannot upload the attribute information !<br>(Cannot connect to content server.)")})}function z(){var b=a("#kalturahost").val(),c=b+"/api_v3/service/session/action/end";a.ajax({type:"GET",url:c,cache:!1}).done(function(a){null===a?window.console.log("Cannot delete the uploadToken ! (Cannot get a XML response.)"):window.console.log("Kaltura Session has been deleted.")}).fail(function(a){window.console.log("Cannot delete the uploadToken ! (Cannot connect to content server.)"),null!==a&&window.console.dir(a)})}var A=0,B=0,C=0,D=!1,E="",F=400,G=300,H=null,I=null,J=null,K=null,L=null,M=window.URL&&window.URL.createObjectURL?function(a){return window.URL.createObjectURL(a)}:window.webkitURL&&window.webkitURL.createObjectURL?function(a){return window.webkitURL.createObjectURL(a)}:void 0,N=window.URL&&window.URL.revokeObjectURL?function(a){return window.URL.revokeObjectURL(a)}:window.webkitURL&&window.webkitURL.revokeObjectURL?function(a){return window.webkitURL.revokeObjectURL(a)}:void 0,O={VIDEO:1,IMAGE:2,AUDIO:5},P={ENTRY_IMPORTING:-2,ENTRY_CONVERTING:-1,ENTRY_IMPORT:0,ENTRY_PRECONVERT:1,ENTRY_READY:2,ENTRY_DELETED:3,ENTRY_PENDING:4,ENTRY_MODERATE:5,ENTRY_BLOCKED:6,ENTRY_NO_CONTENT:7};a(window).on("change",function(){j()}),a(window).on("load",function(){a("#name").val(""),a("#tags").val(""),a("#description").val(""),f()}),a(window).on("unload",function(){null!==J&&(N(J),I=null,J=null),null!==H&&H.stop(),z()}),a(window).resize(g),a("#uploader_cancel").on("click",function(){k()}),a("#name").on("change",function(){j()}),a("#tags").on("change",function(){j()}),a("#entry_submit").on("click",function(){u()}),a("#entry_reset").on("click",function(){q()})}}});